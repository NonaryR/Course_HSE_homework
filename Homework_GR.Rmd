---
title: "Homework"
author: "Gilaztdinov Rustam"
date: "Friday, April 24, 2015"
output: html_document
---
```{r, warning=FALSE, message=FALSE}
library("dplyr")
library("psych")
library("lmtest")
library("sgof")
library("ggplot2") 
library("car")
library("rlms")
library("pander")
library("car") 
library("broom")
library("sandwich")
```

Поместим данные в переменную `data`:
```{r, warning=FALSE, message=FALSE}
data <- read.rlms("r22i_os25a.sav", suppress=TRUE)
````

Возьмем из таблицы переменные, указанные в условии задачи. В дополнение добавим две своих. Я выбрал следующие:
<p>
1. 'rj72.11' - данные о прохождении курсов повышения квалификации;
2. 'rm83.4' - данные об употреблении респондентами алкоголя на рабочем месте.
</p>

По моему мнению, эти две переменные способны оказать влияние на уровень дохода:
```{r}
my_data <- data.frame(zarplata = data[,'rj13.2'], year_born = data[, 'rh6'], 
                      sex = data[,'rh5'], educ = data[,'r_diplom'], 
                      courses = data[,'rj72.11'], alco_on_work = data[,'rm83.4'])
```

Посмотрим на данные: 
```{r,}
pander(head(my_data))
```

В условии задачи сказано, что год рождения необходимо преобразовать в возраст. Для этого возьмем столбец `year_born`, превратим его в вектор и вычтем `год проведения опроса - 2013 г.` из каждого значения вектора. Запишем полученные данные в таблицу `my_data` и посмотрим, как это стало выглядеть:
```{r}
my_year <- my_data$rh6
year_born<-2013-my_year
my_data <- data.frame(zarplata = data[,'rj13.2'], year_born = year_born, 
                      sex = data[,'rh5'], educ = data[,'r_diplom'], 
                      courses = data[,'rj72.11'], alco_on_work = data[,'rm83.4'])
pander(head(my_data))
```

Далее, по условию задачи, необходимо на основе переменной `r_diplom` создать 4 фиктивные переменные:
```{r}
my_educ <-my_data$r_diplom
my_data$neuchi <-as.integer(my_educ=='незаконч среднее образование (7 - 8 кл)' ,
                           'окончил 0 - 6 кл', 
                           'незаконч среднее образование (7 - 8 кл) + что-то еще') 
my_data$srednee <-as.integer(my_educ=='законч среднее образование')
my_data$spec_sred <-as.integer(my_educ=='законч среднее специальное образование')
my_data$high <-as.integer(my_educ=='законч высшее образование и выше')
pander(head(my_data))
```

Переменная `r_diplom` больше не нужна, удалим ее. Также переименуем колонки для наглядности:
```{r}
my_data <- subset(my_data, select = -c(r_diplom))
colnames(my_data) <- c("Zarplata", "Vozrast", "Pol", "Courses", "Alco_on_work",
                          "SrSchool", "School", "Tech", "VUZ")
```

Очистим таблицу от пропущенных значений и посмотрим на нее:
```{r, warning=FALSE, message=FALSE}
clear_data<-na.omit(my_data)
head(clear_data)
```

Данные готовы. Посмотрим их статистические свойства в разрезе нашего интереса:
```{r, warning=FALSE, message=FALSE}
desc <- describe(clear_data)
pander(data.frame(desc[,3:5], desc[,8:9]))
```

Достаточно интересные выводы следуют отсюда:
<p>
1. Средняя зарплата - 21256 р, но не стоит унывать, так как sd достаточно велико;
2. Средний возраст - 41 год;
3. Примерно одинаковое количество людей училось либо в ВУЗе либо окончило только 11 классов школы.
4. Чуть меньше имеет среднее техническое образование, и лишь малая часть, около 2% окончило только 9 классов школы. Оставшиеся респонденты не включены в выборку.
</p>

Визуализируем некоторые переменные для наглядности. Из условия задачи ясно, что надо посторить две гистограммы - дохода и возраста. Сначала построим гистограмму возраста и раскрасим ее, just for fun:
```{r}
colors = c("green", "gold", "red", "violet", "orange", "blue", "pink", 
           "cyan", "seagreen", "yellow", "tan", "tomato") 
hist(clear_data$Vozrast, xlab = "Возраст", main = "Гистограмма возраста", col = colors)
```

Ясно, что основная часть респондентов была в возрасте от 25 до 50 лет. Распределение очень похоже на нормальное, что не может не радовать:
```{r}
hist(clear_data$Zarplata, xlab = "Доход", main = "Гистограмма дохода", col = colors)
```

Доход большей части респондентов расположился в районе 20000 р.

Построим модель, в которую включим все наши переменные и посмотрим на результаты:
```{r}
model_1 = lm(data = clear_data, Zarplata ~ Vozrast + Pol + 
             SrSchool + Tech + VUZ + Alco_on_work + Courses)
coeftest(model_1)
```

Что же, много интересного можно увидеть и здесь:
<p>
1. Estimate - 23533 - было видно из гистограммы дохода;
2. Женщины получают меньше на 7755 р при других равных переменных, что печалит;
3. По образованию все ожидаемо предсказуемо:
<p>
    - окончившие только 9 классов зарабатывают меньше на 2654, хотя не этот фактор у них является определяющим, см. p-value;
    - имеющие среднее специальное образование имеют больше на 2271:
    - выпускники ВУЗ'ов зарабатывают больше на 10709 и эта переменная очень важна.
</p>
4. Самое интересное - модель была построена на стандартных, пьющих на работе переменных. Все они не оказывают весомого влияния на зарплату. Но посмотреть на коэффициенты все равно крайне любопытно.
5. Не посещяющие курсов зарабатывают больше! Расходимся :( Но это неправда, так как p-value безумно велико, логично предположить, что среди респондентов очень мало людей, в чьих интересах продолжать свое обучение.
</p>

Список значимых переменных, которые необходимо включить в работу (требование условия задачи):
<p>
  - Vozrast:
  - Pol;
  - Tech;
  - VUZ.
</p>

Теперь посмотрим на модель, учитывая робастные ошибки:
```{r}
coeftest(model_1,vcov. = vcovHAC(model_1))
```

Объясняющих (имеющих малое p-value) переменных стало больше, что позволяет предположить в данных гетероскедастичность. Хотя все они балансируют на грани, но тем не менее. Значения с переменной употребления алкоголя заметно изменились в сторону значимости, но по-настоящему раскрылась "Затрудняюсь ответить". То есть этот ответ устраивает всех нормальных людей - кто из нас может сказать, что он не пил на праздники на рабочем месте, но как ответить на это однозначно? Поэтому такое значение приобрела эта переменная. Тут имеет место корреляция, с какими - то другими переменными, жаль нет переменной "адекватность респондента" - с ней бы она коррелировала точно.

Список значимых переменных, которые необходимо включить в работу (требование условия задачи):
<p>
  - Vozrast:
  - Pol;
  - SrSchool:
  - Tech;
  - VUZ;
  - Alco_on_work.
</p>